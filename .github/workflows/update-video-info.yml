name: å‹•ç”»æƒ…å ±è‡ªå‹•æ›´æ–°

on:
  schedule:
    - cron: '0 15,21,3,9 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-video-info:
    runs-on: ubuntu-latest
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Chrome/Chromiumã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser
          chromium-browser --version
      
      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          cd get_video_info_script
          pip install -r requirements.txt
      
      - name: å‹•ç”»æƒ…å ±å–å¾—ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
        run: |
          cd get_video_info_script
          chmod +x run.sh
          ./run.sh
        env:
          DISPLAY: ':99'
      
      - name: å¤‰æ›´æ¤œå‡ºã¨PRä½œæˆ
        id: check_changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if git diff --quiet docs/; then
            echo "å¤‰æ›´ãªã—"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "å¤‰æ›´ã‚ã‚Š"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            timestamp=$(date '+%Y%m%d-%H%M%S')
            branch_name="auto-update/video-info-$timestamp"
            echo "branch_name=$branch_name" >> $GITHUB_OUTPUT
            
            git checkout -b "$branch_name"
            git add docs/
            git commit -m "ğŸ¬ å‹•ç”»æƒ…å ±ã‚’è‡ªå‹•æ›´æ–° ($timestamp)"
            git push origin "$branch_name"
          fi
      
      - name: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆã¨ãƒãƒ¼ã‚¸
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const branchName = '${{ steps.check_changes.outputs.branch_name }}';
            const timestamp = new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
            
            // ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ
            const { data: pullRequest } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ¬ å‹•ç”»æƒ…å ±è‡ªå‹•æ›´æ–° - ' + new Date().toLocaleDateString('ja-JP'),
              head: branchName,
              base: 'main',
              body: `## ğŸ“º å‹•ç”»æƒ…å ±ã®è‡ªå‹•æ›´æ–°\n\nå®Ÿè¡Œæ™‚åˆ»: ${timestamp}\n\nGitHub Actionsã«ã‚ˆã‚‹è‡ªå‹•æ›´æ–°ã§ã™ã€‚`
            });
            
            console.log('ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ:', pullRequest.number);
            
            // å°‘ã—å¾…æ©Ÿã—ã¦ã‹ã‚‰ãƒãƒ¼ã‚¸
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒãƒ¼ã‚¸
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pullRequest.number,
              commit_title: 'ğŸ¬ å‹•ç”»æƒ…å ±è‡ªå‹•æ›´æ–°ã‚’ãƒãƒ¼ã‚¸',
              merge_method: 'squash'
            });
            
            console.log('ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸ');
            
            // ãƒ–ãƒ©ãƒ³ãƒã‚’å‰Šé™¤
            await github.rest.git.deleteRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `heads/${branchName}`
            });
            
            console.log('ãƒ–ãƒ©ãƒ³ãƒãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ');
      
      - name: å®Ÿè¡Œçµæœé€šçŸ¥
        if: always()
        run: |
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… å‹•ç”»æƒ…å ±ã®æ›´æ–°ã¨ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä½œæˆ/ãƒãƒ¼ã‚¸ãŒå®Œäº†ã—ã¾ã—ãŸ"
          else
            echo "â„¹ï¸ å‹•ç”»æƒ…å ±ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          fi
