name: å‹•ç”»æƒ…å ±è‡ªå‹•æ›´æ–°

on:
  schedule:
    - cron: '0 15,21,3,9 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-video-info:
    runs-on: ubuntu-latest
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Chrome/Chromiumã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser xvfb
          chromium-browser --version
          # ä»®æƒ³ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã‚’é–‹å§‹
          export DISPLAY=:99
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
      
      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          cd get_video_info_script
          pip install -r requirements.txt
      
      - name: å‹•ç”»æƒ…å ±å–å¾—ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
        run: |
          cd get_video_info_script
          chmod +x run.sh
          # GitHub Actionsç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
          export PYTHONUNBUFFERED=1
          export GITHUB_ACTIONS=true
          ./run.sh
        env:
          DISPLAY: ':99'
          TZ: 'Asia/Tokyo'
          # yt-dlpç”¨ã®è¨­å®š
          YT_DLP_CACHE_DIR: '/tmp/yt-dlp-cache'
      
      - name: å¤‰æ›´æ¤œå‡ºã¨ç›´æ¥ã‚³ãƒŸãƒƒãƒˆ
        id: check_changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if git diff --quiet docs/; then
            echo "å¤‰æ›´ãªã—"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "å¤‰æ›´ã‚ã‚Š"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®è©³ç´°ã‚’å–å¾—
            changed_files=$(git diff --name-only docs/ | tr '\n' ' ')
            echo "changed_files=$changed_files" >> $GITHUB_OUTPUT
            
            timestamp=$(date '+%Y-%m-%d %H:%M:%S JST')
            
            # å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
            git add docs/
            
            # ç›´æ¥mainãƒ–ãƒ©ãƒ³ãƒã«ã‚³ãƒŸãƒƒãƒˆ
            git commit -m "ğŸ¬ å‹•ç”»æƒ…å ±ã‚’è‡ªå‹•æ›´æ–° (${timestamp}) - ãƒ•ã‚¡ã‚¤ãƒ«: ${changed_files}"
            
            # mainãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥
            git push origin main
            
            echo "âœ… å‹•ç”»æƒ…å ±ã®æ›´æ–°ã‚’mainãƒ–ãƒ©ãƒ³ãƒã«ç›´æ¥ã‚³ãƒŸãƒƒãƒˆã—ã¾ã—ãŸ"
          fi
      
      - name: å®Ÿè¡Œçµæœé€šçŸ¥
        if: always()
        run: |
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… å‹•ç”»æƒ…å ±ã®æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸ"
            echo "æ›´æ–°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: ${{ steps.check_changes.outputs.changed_files }}"
          else
            echo "â„¹ï¸ å‹•ç”»æƒ…å ±ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          fi
